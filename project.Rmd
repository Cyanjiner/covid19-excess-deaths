---
title: "Project Proposal"
author: "Jiner Zheng"
date: "10/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load in dataset}
library(dplyr)
library(readr)
library(fpp2)
library(forecast)
library(tseries) # for adf.test() 
library(FinTS) # for ArchTest()
library(dplyr)
library(vrtest) # for Auto.AR()
library(vars)
library(MTS)
library(tsbox)
#excess_death <- read.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/excess-deaths/deaths.csv")
url = "https://raw.githubusercontent.com/akarlinsky/world_mortality/main/world_mortality.csv"
excess_death <- read_csv(url(url))
us_death <- excess_death %>% 
  filter(country_name=="United States")
brazil_death <- excess_death %>% 
  filter(country_name=="Brazil")
russia_death <- excess_death %>% 
  filter(country_name=="Russia")
uk_death <- excess_death %>% 
  filter(country_name=="United Kingdom")
us_ts <- ts(us_death$deaths, frequency = 52,start = c(2015,2))
uk_ts <- ts(uk_death$deaths, frequency = 52,start = c(2015,1))
brazil_ts <- ts(brazil_death$deaths, frequency = 12,start = c(2015,1))
russia_ts <- ts(russia_death$deaths, frequency = 12,start = c(2015,1))
ts.plot(us_ts,ylab="Weekly Deaths from all causes in US")
ts.plot(uk_ts, ylab="Weekly Deaths from all causes in UK")
ts.plot(brazil_ts,ylab="Monthly Deaths from all causes in Brazil")
ts.plot(russia_ts,ylab="Monthly Deaths from all causes in Russia")
```

```{r decomposition plots}
plot(decompose(us_ts))
plot(decompose(uk_ts))
plot(decompose(brazil_ts))
plot(decompose(russia_ts))
```

```{r us tsplots acf pacf}
ggtsdisplay(window(us_ts,end=2020), main="US all deaths plots")
```

```{r uk tsplots acf pacf}
ggtsdisplay(window(uk_ts,end=2020), main="UK all deaths plots")
```

```{r brazil tsplots acf pacf}
ggtsdisplay(window(brazil_ts,end=2020), main="Brazil all deaths plots")
```

```{r russia tsplots acf pacf}
ggtsdisplay(window(russia_ts,end=2020), main="Russia all deaths plots")
```

## US ts predicts
### test for normality & Box.Cox transformation
```{r test for normality}
shapiro.test(us_ts) # p < .05 --> not normal
par(mfrow=c(2,2))
plot(us_ts)
title("Time series of US deaths")
abline(h=mean(us_ts),col="blue",lty=3,lwd=3) #draw line at mean

hist(us_ts, main="Histogram of US deaths", breaks=20, freq=FALSE,col="grey")
us_ts2 <- BoxCox(us_ts,BoxCox.lambda(us_ts))
plot(us_ts2)
title("BoxCox Transformed Time series of US deaths")
abline(h=mean(us_ts2),col="blue",lty=3,lwd=3) #draw line at mean

hist(us_ts2, main="Histogram of BoxCox US deaths", breaks=20, freq=FALSE,col="grey")
```
### test for stationarity
```{r test for stationarity}
adf.test(us_ts2) # P <.05 --> stationary
par(mfrow=c(2,1))
acf(us_ts2, main="ACF of US deaths",lag.max = 52*3) # slow tapering in ACF
pacf(us_ts2, main="PACF of US deaths", lag.max = 52*3) # p=2, P=0
plot(decompose(us_ts2))
```
### ARIMA(2,1,2)(0,1,2)[52]
Since the ACF is slowly decreasing to 0, MA may not be a good model here, so I tried AR with p=2 first. Besides, looking at lags 52, 104, 152, there exist no significant correlations, suggesting we should only consider seasonality D=1 (but also need differencing d=1 because there's a trend in data). Therefore, I first tried a seasonal ARIMA model: ARIMA(2,0,0)(0,1,0)[52] which has an AIC of 2611.79. The auto.arima function suggested another SARIMA model of ARIMA(2,1,2)(0,1,2)[52] that has a slightly better AIC of 2549.16. Therefore, I decided to choose the later one.
```{r select ARIMA or SARIMA}
us_sub <- window(us_ts,end=2019) # to estimate the expected deaths, we do not yet consider time periods after COVID-19
(arima_us <- Arima(us_sub, 
                   order = c(2,0,0),
                   seasonal = list(order=c(0,1,0),
                                   period=52))) #AIC=2611.79
checkresiduals(arima_us)
(sarima_us <- auto.arima(us_sub, trace = F,
                          stepwise = T, #for faster stepwise selection
                          seasonal = T)) # allows for seasonal models
#SARIMA(2,1,2)(0,1,2)[52]: AIC 2549.16
checkresiduals(sarima_us)
```
### check GARCH(0,1)
```{r squared acf and ArchTest}
# check if we need ARCH GARCH
us_arimar <- sarima_us$residuals
acf(us_arimar,lag.max = 50, main="ACF of ARIMA residuals")
acf(us_arimar^2,lag.max = 50, main="ACF of sqaured ARIMA residuals")
#ARCH effect
arimaresArchTest_us <- ArchTest(us_arimar, lags=1, demean=TRUE)
arimaresArchTest_us #<0.05 so there is an ARCH effect
```

```{r GARCH(0,1)}
us.garch1 <- garch(us_arimar,c(0,1),trace=F)
summary(us.garch1)
```

```{r check squared ACF of GARCH residuals}
usgarch.res <- us.garch1$res[-1]
acf(usgarch.res,main="ACF of GARCH residuals")
acf(usgarch.res^2,main="ACF of squared GARCH residuals")
```

```{r plot volatility}
us_vole <- ts(us_arimar^2)
us_vole1 <- ts(us.garch1$fitted.values[-1,1]^2)
plot(us_vole,main="Volatility of data")
plot(us_vole1,main="Volatility of GARCH(0,1)")
```


## Methods: 
### data: 
+ filter by four countries: US, UK, Brazil, Russia.
+ Frequency: Weekly: 52 (US, UK), Monthly: 12 (Brazil, Russia)
+ # of observations in each subset by country and their start, end time of measurement.
+ include selection criteria for country and include time series plots for each country
+ for capstone: dummy variable for
### Excess deaths: 
+ Use 2015-2019 historical data to train on models (naive method, ARIMA, regression, Neural nets?) and get the forecasted values for year 2020 (and maybe 2021).
+ Model selection criteria: AIC
+ Estimate Excess deaths: calculate excess deaths for each time period by taking the difference between expected deaths and reported deaths and summed them up across time to get the final estimate of excess deaths (e.g. c(2020,3) for monthly data).

+ equation for excess deaths estimates in 2020:
\[\text{Estimated Excess Deaths}=\sum_{t\geq t_1}{\text{Actual deaths at time t in 2020}-\text{Predicted Deaths at time t}}\] 

+ equation for predicted/expected deaths in 2020:

if ARIMA: \[D_{t,Y}= \alpha_1D_{t-1,Y} + \alpha_2D_{t-2,Y}+Z_t+\]

+ Cross country comparisons: P-score
\[\text{P-score}=\frac{\text{Reported Deaths - Expected Deaths}}{\text{Expected Deaths}}\]